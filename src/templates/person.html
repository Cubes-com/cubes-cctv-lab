{% extends "base.html" %}

{% block title %}Person Details: {{ name }}{% endblock %}

{% block content %}
<div class="header-actions" style="margin-bottom: 20px;">
    <a href="/" class="btn">Back to Dashboard</a>
    <a href="/training" class="btn">Training</a>
</div>

<h2>Person: {{ name }}</h2>

<h3>Recent Sightings (Logs)</h3>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
    <p style="margin: 0;">These are automatically logged sightings. You can re-assign them if they are incorrect.</p>
    <div>
        <!-- Filter Toggle -->
        <label style="margin-right: 15px; cursor: pointer;">
            <input type="checkbox" id="showConfirmed" onchange="filterSightings()" checked>
            Show Confirmed
        </label>

        <form action="/delete_person" method="post" style="display: inline-block;"
            onsubmit="return confirm('Are you sure you want to delete {{ name }}? This will remove ALL data and images permanently.');">
            <input type="hidden" name="name" value="{{ name }}">
            <button type="submit" style="background-color: #cf6679; color: white; padding: 8px 16px;">
                Delete Person
            </button>
        </form>
    </div>
</div>

<div class="grid" id="sightingsGrid">
    {% for sighting in sightings %}
    <div class="card sighting-card {% if sighting.is_permanent %}confirmed{% else %}unconfirmed{% endif %}"
        data-id="{{ sighting.id }}">
        <div style="position: relative;">
            <img src="/image/{{ sighting.id }}" alt="Sighting {{ sighting.id }}"
                style="width: 100%; border-radius: 4px;">

            <div class="confirmed-badge"
                style="position: absolute; top: 5px; right: 5px; background: green; color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.8em; z-index: 10; {% if not sighting.is_permanent %}display: none;{% endif %}">
                Confirmed
            </div>

            {% if sighting.bbox %}
            <!-- Draw Bounding Box -->
            <div class="bbox-overlay" style="
                position: absolute;
                left: {{ sighting.bbox[0] * 100 }}%;
                top: {{ sighting.bbox[1] * 100 }}%;
                width: {{ (sighting.bbox[2] - sighting.bbox[0]) * 100 }}%;
                height: {{ (sighting.bbox[3] - sighting.bbox[1]) * 100 }}%;
                border: 2px solid {% if sighting.is_permanent %}#00ff00{% else %}#ff0000{% endif %};
                pointer-events: none;
                z-index: 5;
            "></div>
            {% endif %}
        </div>
        <p class="time">{{ sighting.timestamp }}</p>

        <div class="actions">
            <!-- Confirm Button (Only if unconfirmed) -->
            {% if not sighting.is_permanent %}
            <button class="confirm-btn" onclick="confirmSighting({{ sighting.id }}, this)"
                style="width: 100%; background-color: var(--success); color: black; margin-bottom: 5px;">
                Confirm
            </button>
            {% endif %}

            <!-- Re-Assign Existing -->
            <div style="margin-bottom: 5px;">
                <select id="reassign-{{ sighting.id }}" style="width: 70%;">
                    <option value="" disabled selected>Re-assign...</option>
                    {% for id_name in identities %}
                    <option value="{{ id_name }}">{{ id_name }}</option>
                    {% endfor %}
                </select>
                <button onclick="assignSighting({{ sighting.id }})" style="width: 28%;">Go</button>
            </div>

            <!-- Delete -->
            <button onclick="deleteSighting({{ sighting.id }})"
                style="width: 100%; background-color: #cf6679; color: white; margin-bottom: 5px;">Delete</button>

            <!-- Create New (if needed) -->
            <details>
                <summary>Create New Person</summary>
                <form action="/create" method="post" style="margin-top: 10px;">
                    <input type="hidden" name="sighting_id" value="{{ sighting.id }}">
                    <input type="hidden" name="next_url" value="/person/{{ name }}">
                    <input type="text" name="name" placeholder="New Name" required
                        style="width: 100%; margin-bottom: 5px;">
                    <button type="submit" style="width: 100%;">Create & Assign</button>
                </form>
            </details>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    function filterSightings() {
        const showConfirmed = document.getElementById('showConfirmed').checked;
        const cards = document.querySelectorAll('.sighting-card');

        cards.forEach(card => {
            if (card.classList.contains('confirmed')) {
                card.style.display = showConfirmed ? 'block' : 'none';
            }
        });
    }

    async function confirmSighting(id, btn) {
        try {
            const formData = new FormData();
            formData.append('sighting_id', id);
            formData.append('ajax', '1');

            const resp = await fetch('/confirm_sighting', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                // Update UI: Add confirmed badge, remove Confirm button, Green border
                const card = btn.closest('.card');
                card.classList.remove('unconfirmed');
                card.classList.add('confirmed');

                // Show badge
                card.querySelector('.confirmed-badge').style.display = 'block';

                // Update border color
                const bbox = card.querySelector('.bbox-overlay');
                if (bbox) bbox.style.borderColor = '#00ff00';

                // Remove confirm button
                btn.remove();

                // Re-apply filter
                filterSightings();
            } else {
                alert("Failed to confirm");
            }
        } catch (e) {
            console.error(e);
            alert("Error confirming sighting");
        }
    }

    async function deleteSighting(id) {
        if (!confirm("Delete this sighting?")) return;

        try {
            const formData = new FormData();
            formData.append('sighting_id', id);
            formData.append('ajax', '1');

            const resp = await fetch('/delete_sighting', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                // Remove card
                const card = document.querySelector(`.card[data-id='${id}']`);
                if (card) card.remove();
            } else {
                alert("Failed to delete");
            }
        } catch (e) {
            console.error(e);
            alert("Error deleting sighting");
        }
    }

    async function assignSighting(id) {
        const select = document.getElementById(`reassign-${id}`);
        const name = select.value;
        if (!name) return;

        if (!confirm(`Re-assign this sighting to ${name}?`)) return;

        try {
            const formData = new FormData();
            formData.append('sighting_id', id);
            formData.append('name', name);
            formData.append('ajax', '1');

            const resp = await fetch('/assign', {
                method: 'POST',
                body: formData
            });

            if (resp.ok) {
                // Remove card (since it belongs to someone else now)
                const card = document.querySelector(`.card[data-id='${id}']`);
                if (card) card.remove();
            } else {
                alert("Failed to re-assign");
            }
        } catch (e) {
            console.error(e);
            alert("Error re-assigning sighting");
        }
    }

    // Initial filter check
    document.addEventListener("DOMContentLoaded", filterSightings);
</script>
{% endblock %}